Previous[link:files/Tutorial/0%20-%20Intro.html]
Next[link:files/Tutorial/2%20-%20VM%20Control.html]

= VM Setup

VirtualBox allows you to run virtual machines on your local box. During script
development, a local VM can be very handy because it is much faster to access
and reset than a VM hosted far off in the cloud. VirtualBox also allows VM
snapshots, which can quickly restore a particular server state - this
functionality is immensely useful for iterative development.

These are the steps for setting up a Ubuntu VM on VirtualBox.

1. Download and Install VirtualBox (http://www.virtualbox.org)
2. Download a Ubuntu ISO (http://www.ubuntu.com/server/get-ubuntu/download)
3. Build the Box

When done, see the documentation for {controlling a VM}[link:files/Tutorial/2%20-%20VM%20Control.html]

<em>Note these instructions are for building a dev box only.</em>

== Ubuntu

Use the VirtualBox wizard to get started. The name can be changed along with
any of the other settings (ex user, ssh port), but be sure to propagate
changes throughout the setup process.

  - name: abox
  - Linux/Ubuntu
  - 512 MB memory
  - 8 GB dynamically resizing drive

Add the ubuntu iso to the cd/dvd device under Settings > Storage. Now start
the server and install ubuntu (use default settings unless specified):

  - hostname: abox-ubuntu
  - user/password: linecook
  - select 'OpenSSH server' in packages to install

When the server has rebooted and is ready at the login screen, remove the
install iso, take a snapshot and setup port forwarding.

  (Devices > CD/DVD Devices > Remove disk from virtual drive)
  VBoxManage snapshot abox take RAW
  VBoxManage controlvm abox poweroff
  # wait to fully power off
  VBoxManage modifyvm abox --natpf1 'abox-ssh,tcp,,2220,,22'
  VBoxManage -q snapshot abox restore RAW
  VBoxManage startvm abox

Transfer your ssh key to the VM. Help to generate ssh keys can be found on
{GitHub}[http://help.github.com/key-setup-redirect]:

  scp -P 2220 -o UserKnownHostsFile=/dev/null ~/.ssh/id_rsa.pub linecook@localhost:id_rsa.pub
  
Login as linecook and setup SSH:

  vm: mkdir .ssh
  vm: mv id_rsa.pub .ssh/authorized_keys
  vm: chmod 0700 .ssh
  vm: chmod 0600 .ssh/authorized_keys

Remove the login banner as a convenience and exit:

  vm: sudo rm /etc/motd
  vm: exit

Now take a base snapshot:

  VBoxManage snapshot abox take BASE
  VBoxManage controlvm abox poweroff

To cleanup the port forwarding (run later, if ever):

  VBoxManage modifyvm abox --natpf1 delete 'abox-ssh'

The same procedure can be repeated to build other base boxes, including boxes
with other operating systems. Again, nothing is special about Ubuntu, the
name, port, or other settings. Modify the setup to your liking - all that
Linecook requires is ssh access.

Previous[link:files/Tutorial/0%20-%20Intro.html]
Next[link:files/Tutorial/2%20-%20VM%20Control.html]
