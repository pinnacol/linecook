#! /bin/sh
############################################################################

ssh_config_file=${SSH_CONFIG_FILE:-config/ssh}
remote_dir=${REMOTE_DIR:-vm/pkg}

usage="usage: %s [-F SSH_CONFIG_FILE] [-D REMOTE_DIR] [-h] PACKAGE_DIRS...\n"
option="       %s   %s\n"
while getopts "F:D:h" opt
do
  case $opt in
  F  ) ssh_config_file=$OPTARG ;;
  D  ) remote_dir=$OPTARG ;;
  h  ) printf "$usage" $0
       printf "$option" "-h" "prints this help"
       exit 0 ;;
  \? ) printf "$usage" $0
       exit 2 ;;
  esac
done
shift $(($OPTIND - 1))

################################# transfer #################################

errors=0
for package_dir in "$@"
do
host=$(basename -- "$package_dir")

ssh -q -T -F "$ssh_config_file" "$host" -- <<SCRIPT
rm -rf "$remote_dir/$host"
if [ "$remote_dir" != "" ]
then
  mkdir -p "$remote_dir"
fi
SCRIPT

scp -q -r -F "$ssh_config_file" "$package_dir" "$host:$remote_dir"

status=$?
if [ $status -ne 0 ]
then
  echo "[$status] $remote_dir/$host/$script_name " >&2
  errors=$(($errors+1))
fi
done

exit $errors

################################ (transfer) ################################
