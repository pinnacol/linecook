#!/usr/bin/env ruby

require 'linecook/version'
require 'linecook/command_set'
require 'linecook/commands/compile'

if ARGV.empty?
  ARGV.unshift('--help')
end

executable = Linecook::CommandSet.new(
  'compile' => Linecook::Commands::Compile
)

executable.parse!(ARGV) do |options|
  options.on("-h", "--help", "print this help") do
    puts "usage: linecook [options] COMMAND [ARGS]"
    puts
    puts "commands: "
    executable.command_list.each do |name, command|
      puts "  %-16s   %s" % [name, command.desc]
    end
    puts
    puts "options:"
    puts options.to_s.gsub(/^  /, '').gsub(/\s{14}/, '') # hack to fix spacing

    exit
  end

  options.on("-v", "--version", "print version") do |v|
    puts "linecook version #{Linecook::VERSION} -- #{Linecook::WEBSITE}"
    exit
  end
end

begin
  executable.call(ARGV) do |command, options|
    options.on '-h', '--help', 'print this help' do
      puts "usage: linecook #{command.name} #{command.args}"
      puts

      desc = command.desc
      unless desc.nil? || desc.empty?
        puts
        puts command.desc.wrap
        puts
      end

      puts "options:"
      puts options.to_s.gsub(/^  /, '').gsub(/\s{14}/, '') # hack to fix spacing

      exit
    end
  end
rescue Linecook::Command::CommandError
  puts $!.message
  puts $!.backtrace if $DEBUG
  exit 1
end
