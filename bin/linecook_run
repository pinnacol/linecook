#! /bin/sh
############################################################################

ssh_config_file=${SSH_CONFIG_FILE:-config/ssh}
ssh_opts=${SSH_OPTS:--q -T}
scp_opts=${SCP_OPTS:--q}
run_script=${RUN_SCRIPT:-run}
test_script=${TEST_SCRIPT:-test}
remote_dir=${REMOTE_TEST_DIR:-vm/test}

usage="usage: %s [-F=SSH_CONFIG_FILE] [-r=RUN_SCRIPT] [-t=TEST_SCRIPT] [-d=REMOTE_DIR] [-h] PACKAGE_DIRS...\n"
option="       %s   %s\n"
while getopts "F:r:c:d:vh" opt
do
  case $opt in
  F  ) ssh_config_file=$OPTARG ;;
  r  ) run_script=$OPTARG ;;
  c  ) test_script=$OPTARG ;;
  d  ) remote_dir=$OPTARG ;;
  h  ) printf "$usage" $0
       printf "$option" "-h" "prints this help"
       exit 0 ;;
  \? ) printf "$usage" $0
       exit 2 ;;
  esac
done
shift $(($OPTIND - 1))

check_status () {
  exitstatus=$1; lineno=$2; message=$3
  
  if [ $exitstatus -ne 0 ]
  then
    echo "[$0:$lineno] $message"
    exit $exitstatus
  fi
}

################################### test ###################################

#
# run packages
#

for package_dir in "$@"
do
host=$(basename -- "$package_dir")

ssh $ssh_opts -F "$ssh_config_file" "$host" -- <<SETUP
rm -rf "$remote_dir/$host"
if [ "$remote_dir" != "" ]
then
  mkdir -p "$remote_dir"
fi
SETUP
check_status $? $LINENO "remote dir setup failure: $remote_dir/$host"

scp $scp_opts -r -F "$ssh_config_file" "$package_dir" "$host:$remote_dir"
check_status $? $LINENO "scp failure: $package_dir $host:$remote_dir"

ssh $ssh_opts -F "$ssh_config_file" "$host" -- <<RUN
cd "$remote_dir/$host"
if [ -f "$run_script" ]
then
  chmod +x "$run_script"
  sudo ./"$run_script"
fi
RUN
check_status $? $LINENO "non-zero exit status: $package_dir/$run_script"
done

#
# test packages
#

for package_dir in "$@"
do
host=$(basename -- "$package_dir")

ssh $ssh_opts -F "$ssh_config_file" "$host" -- <<TEST
cd "$remote_dir/$host"
if [ -f "$test_script" ]
then
  chmod +x "$test_script"
  ./"$test_script"
fi
TEST
check_status $? $LINENO "non-zero exit status: $package_dir/$test_script"
done
################################## (test) ##################################
